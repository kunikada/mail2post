# Mail2Post システム要件定義書

## 1. 概要

Mail2Post は、特定のメールアドレスに送信されたメールを受信し、メールの内容を指定されたウェブサービスに HTTP
POST リクエストとして転送するシステムです。このシステムは AWS のサーバーレスアーキテクチャを活用して構築されます。

## 2. 目的

システムの主な目的は以下の通りです：

- Eメールによるデータ入力を Web API へと自動変換する
- サーバーレスアーキテクチャによる高いスケーラビリティとコスト効率を実現する
- メンテナンスが容易で信頼性の高いシステムを構築する

## 3. 機能要件

### 3.1 メール受信機能

- 特定のメールアドレス宛てに送信されたメールを受信する
- AWS SES (Simple Email Service) を使用してメールを受け取る
- メールの認証および不正メール対策を含む

#### 3.1.1 メールアドレスルーティング機能

- 複数のメールアドレスを設定し、それぞれに異なるPOST先を指定可能
- 受信メールアドレスに基づいて適切なPOST先にルーティング
- メールアドレスごとに個別の変換ルールやヘッダー設定を適用可能
- アドレスとPOST先の組み合わせの動的な追加・変更・削除機能
- メールアドレスのパターンマッチング（ワイルドカード等）によるルーティング（オプション）

### 3.2 メール処理機能

- 受信したメールから必要な情報を抽出する
- メールの本文、件名、添付ファイル（オプション）などを処理する
- メールのフォーマットに応じて適切にパースする（テキスト、HTML など）

#### 3.2.1 HTMLメール処理

- HTMLメールの本文からテキスト抽出またはHTML構造の保持（設定可能）
- マルチパートメール（HTML/プレーンテキスト両方含む）の処理ポリシー
- インライン画像の処理（Base64エンコードまたはURLへの変換）
- HTMLメール特有のスタイリングや構造を維持または削除するオプション

### 3.3 HTTP POST 機能

- 抽出した情報を指定された URL に HTTP POST リクエストとして送信する
- 設定可能なヘッダー、認証方式をサポートする
- POST リクエストのフォーマットを設定できるようにする（JSON、x-www-form-urlencoded など）

#### 3.3.1 複数エンドポイント POST 機能

- 1つのメールを受信した際に、複数の異なるエンドポイントに送信可能
- エンドポイントごとに個別の設定（フォーマット、認証、ヘッダーなど）をサポート
- 各エンドポイントに固有の変換ルールを適用可能
- プライマリエンドポイントと追加エンドポイントの区別による優先度設定
- エンドポイントごとに成功/失敗を個別に処理

#### 3.3.2 Slack 連携機能

- Slack Incoming Webhookを利用したメッセージ送信
- チャンネル、ユーザー名、アイコンなどのカスタマイズ
- メールの件名、送信者、本文を適切なフォーマットでSlackメッセージに変換
- 添付ファイルの存在通知と必要に応じてリンク提供
- HTMLメールの場合は適切にテキスト変換して送信
- メッセージのスレッド化やリッチテキスト対応（オプション）

### 3.4 エラー処理とログ機能

- 処理エラーの適切な管理とログ記録
- 配信失敗時の再試行メカニズム
- 管理者への通知システム

## 4. 非機能要件

### 4.1 パフォーマンス

- メール受信から POST リクエスト送信までの最大処理時間：30秒以内
- 同時処理可能なメール数：最大100通/分

### 4.2 スケーラビリティ

- 負荷に応じて自動的にスケールする
- 処理量の急増に対応できる設計

### 4.3 セキュリティ

- メール内の機密情報の適切な処理
- API エンドポイントへの認証機能
- データの暗号化（転送中および保存時）

### 4.4 可用性

- システム稼働率：99.9%以上
- 計画的なメンテナンス時間を除き、24時間365日稼働

### 4.5 監視と運用

- システムの状態監視
- アラート機能
- パフォーマンスメトリクスの収集

## 5. 技術スタック

### 5.1 AWS サービス

- Amazon SES (Simple Email Service)：メールの受信
- AWS Lambda：メール処理とPOSTリクエスト実行
- Amazon S3：一時的なメールストレージ（必要に応じて）
- Amazon CloudWatch：監視とログ記録
- AWS IAM：アクセス制御

### 5.2 開発ツール

- Serverless Framework、Node.js等のバージョンは[common-config.md](./common-config.md)を参照
- TypeScript：開発言語
- Git：バージョン管理

## 6. アーキテクチャ

```
[メール送信者] → [Amazon SES] → [S3 バケット] → [Lambda 関数] → [外部 API/Webサービス]
                                                     ↓
                                              [CloudWatch Logs]
```

## 7. 展開とテスト戦略

### 7.1 展開方法

- Serverless Framework を使用した自動デプロイ
- 開発、ステージング、本番環境の分離

### 7.2 テスト戦略

- ユニットテスト：個々の関数のテスト
- 統合テスト：コンポーネント間の連携テスト
- エンドツーエンドテスト：実際のメール送信からPOSTリクエストまでの全体フロー

## 8. 制約事項

- AWS リージョンの選択（レイテンシーとコンプライアンスを考慮）
- SES の制限事項への対応
- メールサイズの制限（添付ファイルを含む）

## 9. 今後の拡張性

- メール内容に基づいた条件付き転送ルール
- Web ダッシュボードによるシステム管理
- 処理結果の履歴管理と再実行機能
