# テスト戦略と基本方針

## 概要

Mail2Postプロジェクトのテスト戦略と基本的な考え方を定めています。

## テスト戦略の基本原則

### 1. 実環境優先主義

**方針**: シミュレーションツールやエミュレータは使用せず、実際のAWSサービスでテストを実施

**理由**:
- 本番環境との差異を最小化
- 実際のAWSサービス動作の確認
- デプロイ前の問題発見確率向上

**適用範囲**: 結合テスト、システムテスト

### 2. レイヤー別テスト戦略

**ユニットテスト**:
- 個別コンポーネントの動作確認（モック使用）
- ビジネスロジックの単体検証
- 実行環境: Devcontainer（ローカル）

**結合テスト**:
- AWSサービス間の連携動作確認（実際のサービス使用）
- エンドツーエンドでのメール処理フロー検証
- 実行環境: AWS開発環境（devステージ）

### 3. シンプルなテスト用API設計

**設計原則**:
- 必要最小限のリソース（API Gateway + Lambda）
- エコーバック方式によるリクエスト検証
- HTTPステータスコードとレスポンス内容による判定

**避けるもの**:
- 複雑なデータベース依存
- 過度なインフラストラクチャ
- 保守コストの高い仕組み

## テスト対象範囲と検証項目

### ユニットテスト

**対象範囲**:
- 個別の関数・クラスの動作確認
- ビジネスロジックの単体検証
- サービス間の境界テスト（モック使用）

### 結合テスト

**対象範囲**:
- エンドツーエンドでのメール処理フロー
- AWSサービス間の連携動作  
- テスト用APIへのHTTPリクエスト送信と検証

**使用するサービス**:
- SendGrid（統合テスト用メール送信）
- Amazon SES（メール受信）
- AWS Lambda（本番用機能とテスト用API）
- Amazon S3（メール保存・設定ファイル管理）
- Amazon API Gateway（テスト用Webhookエンドポイント）

**統合テストフロー**:
```
SendGrid SMTP → SES受信 → Lambda処理 → Webhook送信 → 結果検証
```

**SendGrid設定**:
- テスト専用SMTP設定: `config/sendgrid.json`
- 認証情報管理: gitignoreで除外
- 接続テスト: beforeAllで事前確認

## 品質保証の考え方

### テスト駆動開発（TDD）

**原則**:
- 機能実装前にテストケースを作成
- レッド→グリーン→リファクタのサイクル
- 継続的な品質向上

### 継続的インテグレーション

**方針**:
- コミット時の自動テスト実行
- 結合テストによる早期問題発見
- 自動化による効率化

### 監視とロギング

**戦略**:
- Lambda関数の実行ログ監視
- エラー発生時のアラート設定
- パフォーマンス指標の継続的収集

## コスト管理と並列実行の考慮事項

### コスト管理

**基本方針**:
- 結合テストでは実際のAWSサービスを使用するため少額の利用料金が発生
- テスト完了後の適切なリソースクリーンアップ実行
- 不要なリソースの長時間放置回避

### 並列実行制御

**考慮事項**:
- 複数開発者による同時テスト実行時のリソース競合回避
- CI/CD環境での適切なリソース管理
- テスト実行順序の調整

## シミュレーションツールを使用しない理由

### 1. 実環境との差異問題

- エミュレータと実際のAWSサービスでは動作が異なる場合がある
- 設定やAPIの細かな違いが本番環境で問題となる可能性
- 本番デプロイ後に発見される問題の増加リスク

### 2. 設定・維持コスト

- エミュレータの設定・維持には追加の学習コストが必要  
- 実際のAWSサービスの方が設定が簡単で保守性が高い
- チーム全体の習得コストの削減

### 3. テストの信頼性

- 本番環境と同じ環境でのテストによる信頼性向上
- デプロイ前の問題発見確率の向上
- 運用時のトラブル減少

---

## 詳細な実装と実行手順

**テストの具体的な実行方法、セットアップ手順、トラブルシューティングについては [CONTRIBUTING_ja.md](../CONTRIBUTING_ja.md) の「テスト実施」セクションを参照してください。**
