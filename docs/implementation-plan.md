# Mail2Post 実装計画

## 1. 開発フェーズ

### フェーズ1: プロジェクト設定とインフラ準備（2週間）

- プロジェクト構造の設定
- TypeScript開発環境のセットアップ（バージョンは[common-config.md](./common-config.md)参照）
- AWS アカウントの準備と構成
- Serverless Frameworkの設定
- 基本的なCI/CDパイプラインの構築

### フェーズ2: コア機能の実装（4週間）

- Lambda関数の開発
  - メール受信処理
  - メール内容の解析
  - HTMLメール処理機能
  - POSTリクエスト処理
  - 複数エンドポイント処理機能
  - Slack連携機能
- SES設定の実装
- エラーハンドリングの実装

### フェーズ3: テストと最適化（2週間）

- ユニットテストの作成
- 統合テストの実施
- パフォーマンステスト
- セキュリティテスト

### フェーズ4: ドキュメンテーションと展開（1週間）

- ユーザードキュメントの作成
- 運用マニュアルの作成
- 本番環境への展開

## 2. 主要なマイルストーン

1. **プロジェクト開始**: 2025年5月21日
2. **インフラ設定完了**: 2025年6月4日
3. **コア機能実装完了**: 2025年7月2日
4. **テスト完了**: 2025年7月16日
5. **本番環境リリース**: 2025年7月23日

## 3. 開発タスク詳細

### 3.1 Serverless設定ファイルの作成

- SES、Lambda、S3、IAMの設定
- 環境別設定ファイル（config/{stage}.json）の作成
- スケーリングパラメータの設定
- TypeScriptサポートのための設定（バージョンは[common-config.md](./common-config.md)参照）

### 3.1.1 TypeScript設定

- tsconfig.jsonの設定
- 型定義ファイルの作成
- 開発環境のセットアップ（ESLint、Prettier）
- ビルドスクリプトの設定

### 3.1.2 IAM権限設定の実装

- Lambda実行ロールの定義
- SES→Lambda連携の権限設定
- S3バケットアクセス権限の設定
- 環境別の権限分離の実装
- IAMポリシーのレビューと最小権限化
- クロスサービス保護設定（混乱した代理問題対策）

### 3.2 Lambda関数の開発

- TypeScriptでのメールパーサーの実装
- 型定義を活用したPOSTリクエストクライアントの実装
- エラーハンドリングとリトライロジックの実装
- ログ記録機能の実装
- インターフェースと型定義の作成

#### 3.2.1 HTMLメール処理機能の開発

- HTML解析ライブラリの評価と選定
- テキスト変換機能の実装
- インライン画像処理の実装
- マルチパートMIMEメッセージの処理実装
- 設定オプションのインターフェース設計

#### 3.2.2 HTMLメール処理のテスト

- さまざまなHTMLメール形式でのテスト（シンプルなHTML、複雑なレイアウト）
- インライン画像を含むメールのテスト
- 異なるメーラーから送信されたHTMLメールのテスト（Outlook, Gmail, Apple Mail）
- エンコーディングの異なるメールのテスト（UTF-8, ISO-2022-JP など）

#### 3.2.3 複数エンドポイント処理機能の開発

- 複数エンドポイント設定管理クラスの設計と実装
- 設定ファイルからのエンドポイント情報の読み込み処理
- エンドポイントごとの個別リクエスト生成処理
- 並列またはシーケンシャルなリクエスト処理の制御実装
- エンドポイント別のエラー処理と独立したリトライロジック

#### 3.2.4 メールアドレスルーティング機能の開発

- ルーティング設定JSONファイルスキーマの設計と実装
- メールアドレスパターンマッチングエンジンの実装
- JSONファイルベースのルーティング設定の読み込み処理
- 設定ファイルの監視と動的な再読み込み機能の実装
- アドレスパターンバリデーションメカニズムの実装
- ルーティングのパフォーマンス最適化
- Slack通知タイプのルート処理の統合実装
- ルーティングテスト用のモックシステム開発

#### 3.2.5 Slack連携機能の開発

- Slack Webhook APIクライアントの実装
- ルーティング設定内でのSlackルートの処理実装
- メールからSlackメッセージへの変換ロジック実装
- メッセージフォーマットとレイアウトの設計
- 添付ファイル情報の適切な表示
- メッセージブロックキットの活用によるリッチ表示の実装
- エラーハンドリングとロギングの実装

### 3.3 AWS SES設定

- メール受信ルールの設定
- スパム対策設定
- S3バケットへの保存設定（オプション）

### 3.4 監視とアラート設定

- CloudWatch アラームの設定
- エラー通知メカニズムの実装
- パフォーマンスメトリクスの収集設定

## 4. 必要なリソース

### 4.1 開発環境

- Node.js開発環境
- TypeScript開発環境
- AWS CLI
- Serverless Framework
- テスト用のSMTPクライアント
- ESLint、Prettierなどの開発ツール

### 4.2 AWS リソース

- AWS アカウント
- SES設定（ドメイン検証含む）
- Lambda関数
- S3バケット（オプション）
- IAMロール
- CloudWatchダッシュボード

## 5. リスクと対策

| リスク               | 影響度 | 対策                                                                |
| -------------------- | ------ | ------------------------------------------------------------------- |
| SESの送信制限        | 中     | 段階的な制限引き上げリクエスト、キューイングメカニズムの実装        |
| Lambda実行時間の制限 | 低     | 効率的なコード実装、必要に応じて処理の分割                          |
| 外部APIの可用性      | 高     | リトライメカニズム、デッドレターキュー、通知システムの実装          |
| セキュリティ脆弱性   | 高     | 定期的なセキュリティレビュー、最小権限原則の適用                    |
| IAM権限の過剰付与    | 高     | 最小権限原則の徹底、IAM Access Analyzerの利用、定期的な権限レビュー |
| 認証情報の漏洩       | 高     | アクセスキーの非使用、Secrets Managerの活用、環境変数の暗号化       |

## 6. 開発者向け参考情報

- Serverless Framework ドキュメント: https://www.serverless.com/framework/docs/
- AWS SES API リファレンス: https://docs.aws.amazon.com/ses/latest/APIReference/
- AWS Lambda ドキュメント: https://docs.aws.amazon.com/lambda/latest/dg/welcome.html
- TypeScript ドキュメント: https://www.typescriptlang.org/docs/
- TypeScript AWS SDK: https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/
- Node.js HTTP リクエストライブラリオプション: axios, node-fetch, got
